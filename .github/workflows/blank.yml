name: CI with docker

on:
  push:
    branches:
      - main

jobs:
  docker-build-push:
    runs-on: ubuntu-latest
    outputs:
      deployment_guid: ${{ steps.guid.outputs.deployment_guid }}

    steps:
      # 1️⃣ Checkout code
      - name: Checkout
        uses: actions/checkout@v4

      # 2️⃣ Generate Deployment GUID
      - name: Generate GUID
        id: guid
        run: echo "deployment_guid=${{ github.run_number }}-${{ github.sha }}" >> $GITHUB_OUTPUT

      # 3️⃣ Login to Docker Hub
      - name: Docker Login
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # 4️⃣ Build Docker Image
      - name: Build Image
        run: |
          docker build \
            --build-arg DEPLOYMENT_GUID=${{ steps.guid.outputs.deployment_guid }} \
            -f app/Dockerfile \
            -t ${{ secrets.DOCKERHUB_USERNAME }}/test-github-actions-with-renderer:${{ steps.guid.outputs.deployment_guid }} \
            -t ${{ secrets.DOCKERHUB_USERNAME }}/test-github-actions-with-renderer:latest \
            app

      # 5️⃣ Push Docker Image
      - name: Push Image
        run: |
          docker push ${{ secrets.DOCKERHUB_USERNAME }}/test-github-actions-with-renderer:${{ steps.guid.outputs.deployment_guid }}
          docker push ${{ secrets.DOCKERHUB_USERNAME }}/test-github-actions-with-renderer:latest

  # 6️⃣ Deploy to Render using IMAGE:GUID
  #- name: Deploy to Render
  #  run: |
  #    curl -X POST \
  #      "https://api.render.com/v1/services/${{ secrets.RENDER_SERVICE_ID }}/deploys" \
  #      -H "Authorization: Bearer ${{ secrets.RENDER_API_KEY }}" \
  #      -H "Content-Type: application/json" \
  #      -d '{
  #        "clearCache": "do_not_clear",
  #        "imageUrl": "docker.io/${{ secrets.DOCKERHUB_USERNAME }}/test-github-actions-with-renderer:${{ env.DEPLOYMENT_GUID }}",
  #        "deployMode": "build_and_deploy"
  #      }'

#  deploy-staging:
#    name: deploy to staging
#    needs: docker-build-push
#    runs-on: ubuntu-latest
#    environment: staging
#    outputs:
#      deployment_guid: ${{ needs.docker-build-push.outputs.deployment_guid }}
#
#    steps:
#      - name: Deploy to Render
#        run: |
#          curl -X POST \
#            "https://api.render.com/v1/services/${{ secrets.RENDER_SERVICE_ID_STG }}/deploys" \
#            -H "Authorization: Bearer ${{ secrets.RENDER_API_KEY }}" \
#            -H "Content-Type: application/json" \
#            -d '{
#              "clearCache": "do_not_clear",
#              "imageUrl": "docker.io/${{ secrets.DOCKERHUB_USERNAME }}/test-github-actions-with-renderer:${{ needs.docker-build-push.outputs.deployment_guid }}",
#              "deployMode": "build_and_deploy"
#            }'
#
#  deploy-production:
#    name: deploy to production
#    needs: deploy-staging
#    runs-on: ubuntu-latest
#    environment: production
#
#    steps:
#      - name: Deploy to Render
#        run: |
#          curl -X POST \
#            "https://api.render.com/v1/services/${{ secrets.RENDER_SERVICE_ID_PROD }}/deploys" \
#            -H "Authorization: Bearer ${{ secrets.RENDER_API_KEY }}" \
#            -H "Content-Type: application/json" \
#            -d '{
#              "clearCache": "do_not_clear",
#              "imageUrl": "docker.io/${{ secrets.DOCKERHUB_USERNAME }}/test-github-actions-with-renderer:${{ needs.deploy-staging.outputs.deployment_guid }}",
#              "deployMode": "build_and_deploy"
#            }'

  deploy-staging:
    name: deploy to staging
    needs: docker-build-push
    runs-on: ubuntu-latest
    environment: staging
    outputs:
      deployment_guid: ${{ needs.docker-build-push.outputs.deployment_guid }}

    steps:
      - uses: actions/checkout@v4

      - name: Install Railway CLI
        run: npm install -g @railway/cli

      - name: Deploy to Render
        run: |
          railway up app \
            --service ${{ secrets.RAILWAY_SERVICE_ID_STAGING }} \
            --environment staging \
            --message "Deploy ${{ needs.docker-build-push.outputs.deployment_guid }}"
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN_STAGING }}
          RAILWAY_PROJECT_ID: ${{ secrets.RAILWAY_PROJECT_ID }}

  deploy-production:
    name: deploy to production
    needs: deploy-staging
    runs-on: ubuntu-latest
    environment: production

    steps:
      - uses: actions/checkout@v4

      - name: Install Railway CLI
        run: npm install -g @railway/cli

      - name: Deploy to Render
        run: |
          railway up app \
            --service ${{ secrets.RAILWAY_SERVICE_ID_PRODUCTION }} \
            --environment production \
            --message "Deploy ${{ needs.deploy-staging.outputs.deployment_guid }}"
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN_PRODUCTION }}
          RAILWAY_PROJECT_ID: ${{ secrets.RAILWAY_PROJECT_ID }}
