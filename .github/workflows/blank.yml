name: CI with docker

on:
  push:
    branches:
      - main

jobs:
  docker-build-push:
    runs-on: ubuntu-latest
    outputs:
      deployment_guid: ${{ steps.guid.outputs.DEPLOYMENT_GUID }}

    steps:
      # 1️⃣ Checkout code
      - name: Checkout
        uses: actions/checkout@v4

      # 2️⃣ Generate Deployment GUID
      - name: Generate GUID
        id: guid
        run: echo "DEPLOYMENT_GUID=${{ github.run_number }}-${{ github.sha }}" >> $GITHUB_ENV

      # 3️⃣ Login to Docker Hub
      - name: Docker Login
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # 4️⃣ Build Docker Image
      - name: Build Image
        run: |
          docker build \
            --build-arg DEPLOYMENT_GUID=${{ env.DEPLOYMENT_GUID }} \
            -f app/Dockerfile \
            -t ${{ secrets.DOCKERHUB_USERNAME }}/test-github-actions-with-renderer:${{ env.DEPLOYMENT_GUID }} \
            -t ${{ secrets.DOCKERHUB_USERNAME }}/test-github-actions-with-renderer:latest \
            app

      # 5️⃣ Push Docker Image
      - name: Push Image
        run: |
          docker push ${{ secrets.DOCKERHUB_USERNAME }}/test-github-actions-with-renderer:${{ env.DEPLOYMENT_GUID }}
          docker push ${{ secrets.DOCKERHUB_USERNAME }}/test-github-actions-with-renderer:latest

  # 6️⃣ Deploy to Render using IMAGE:GUID
  #- name: Deploy to Render
  #  run: |
  #    curl -X POST \
  #      "https://api.render.com/v1/services/${{ secrets.RENDER_SERVICE_ID }}/deploys" \
  #      -H "Authorization: Bearer ${{ secrets.RENDER_API_KEY }}" \
  #      -H "Content-Type: application/json" \
  #      -d '{
  #        "clearCache": "do_not_clear",
  #        "imageUrl": "docker.io/${{ secrets.DOCKERHUB_USERNAME }}/test-github-actions-with-renderer:${{ env.DEPLOYMENT_GUID }}",
  #        "deployMode": "build_and_deploy"
  #      }'

  deploy-staging:
    name: deploy to staging
    needs: docker-build-push
    runs-on: ubuntu-latest
    environment: staging
    outputs:
      deployment_guid: ${{ needs.docker-build-push.outputs.deployment_guid }}

    steps:
      - name: Deploy to Render
        run: |
          curl -X POST \
            "https://api.render.com/v1/services/${{ secrets.RENDER_SERVICE_ID }}/deploys" \
            -H "Authorization: Bearer ${{ secrets.RENDER_API_KEY }}" \
            -H "Content-Type: application/json" \
            -d '{
              "clearCache": "do_not_clear",
              "imageUrl": "docker.io/${{ secrets.DOCKERHUB_USERNAME }}/test-github-actions-with-renderer:${{ needs.docker-build-push.outputs.deployment_guid }}",
              "deployMode": "build_and_deploy"
            }'

  deploy-production:
    name: deploy to production
    needs: deploy-staging
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Deploy to Render
        run: |
          curl -X POST \
            "https://api.render.com/v1/services/${{ secrets.RENDER_SERVICE_ID }}/deploys" \
            -H "Authorization: Bearer ${{ secrets.RENDER_API_KEY }}" \
            -H "Content-Type: application/json" \
            -d '{
              "clearCache": "do_not_clear",
              "imageUrl": "docker.io/${{ secrets.DOCKERHUB_USERNAME }}/test-github-actions-with-renderer:${{ needs.deploy-staging.outputs.deployment_guid }}",
              "deployMode": "build_and_deploy"
            }'